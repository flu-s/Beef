package com.project.beef.service;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.multipart.MultipartFile;
import com.project.beef.domain.Cut;
import com.project.beef.repository.CutRepository;
import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class CutService {
    private final CutRepository cutRepository;

    public List<Cut> getList() { return cutRepository.findAll(); }

    public Map<String, Object> analyzeMeat(MultipartFile file) {
        Map<String, Object> result = new HashMap<>();
        try {
            // 1. 로컬 파이썬 Flask 서버 주소
            String url = "http://localhost:5000/predict";

            // 2. Multipart 전송 설정
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.MULTIPART_FORM_DATA);
            
            MultiValueMap<String, Object> body = new LinkedMultiValueMap<>();
            body.add("file", file.getResource());
            
            HttpEntity<MultiValueMap<String, Object>> requestEntity = new HttpEntity<>(body, headers);
            RestTemplate restTemplate = new RestTemplate();
            
            // 3. 분석 요청 (Flask 서버 호출)
            Map<String, Object> aiResponse = restTemplate.postForObject(url, requestEntity, Map.class);

            // 4. 결과 매핑 (부위와 등급 분리)
            result.put("detectedPart", aiResponse.get("detectedPart")); // 부위 결과
            result.put("detectedGrade", aiResponse.get("detectedGrade")); // 등급 결과
            result.put("marblingRatio", aiResponse.get("marblingRatio"));
            result.put("insight", aiResponse.get("insight"));
            result.put("visualizedUrl", "/images/analysis/mask_latest.png");

        } catch (Exception e) {
            e.printStackTrace();
            result.put("insight", "로컬 분석 서버 통신 오류");
        }
        return result;
    }
}