package com.project.beef.controller;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import com.project.beef.domain.Cut;
import com.project.beef.dto.CutDto;
import com.project.beef.dto.SaveRequestDto;
import com.project.beef.service.CutService;

import jakarta.servlet.http.HttpServletRequest;
import lombok.RequiredArgsConstructor;

import java.security.Principal;

@RestController
@RequestMapping("/api/cut") 
@RequiredArgsConstructor
public class CutController {

    private final CutService cutService;

    /**
     * 1. POST /api/cut/analyze : ë¶€ìœ„ ì¸¡ì • ë° DB ì €ì¥ í†µí•© API (ìˆ˜ì •ë¨)
     * í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ ì´ë¯¸ì§€ íŒŒì¼ë¡œ ë¶€ìœ„ ë¶„ì„ í›„, ê·¸ ê²°ê³¼ë¥¼ DBì— ì €ì¥í•©ë‹ˆë‹¤.
     */
    @PostMapping("/analyze")
    public ResponseEntity<?> analyzeAndSave(@RequestParam("file") MultipartFile file, Principal principal) {
        
        if (file.isEmpty()) {
            return ResponseEntity.badRequest().body("ì—…ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
        }

        // 1. í˜„ì¬ ì‚¬ìš©ì ID ì¶”ì¶œ (ê°€ì¥ ì¤‘ìš”!)
        String memberId = null;
        if (principal != null) {
            // Spring Securityê°€ ì¸ì¦ ì„±ê³µ ì‹œ JWTì—ì„œ ì¶”ì¶œí•œ ì‚¬ìš©ì IDë¥¼ Principalì— ë„£ì–´ì¤ë‹ˆë‹¤.
            memberId = principal.getName(); 
            System.out.println("DEBUG: í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ID: " + memberId);
        } else {
            // ì¸ì¦ ì—†ì´ ì ‘ê·¼í–ˆë‹¤ë©´ (í˜¹ì‹œ ëª¨ë¥¼ ìƒí™© ëŒ€ë¹„)
            System.err.println("ê²½ê³ : ì¸ì¦ ì •ë³´(Principal)ê°€ ì—†ì–´ memberIdë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        try {
            // 2. ë¶€ìœ„ ë¶„ì„ (AI ì„œë²„ í†µì‹ )
            CutDto partResult = cutService.analyzePart(file);
            
            // 3. SaveRequestDto ìƒì„± ë° DB ì €ì¥
            // DTO ìƒì„± ì‹œ memberId í¬í•¨
            SaveRequestDto saveDto = SaveRequestDto.builder()
                .detectedPart(partResult.getDetectedPart() != null ? partResult.getDetectedPart() : "Unknown")
                .detectedGrade("ë¯¸ì¸¡ì •") 
                .marblingRatio(0) 
                .insight(partResult.getInsight() != null ? partResult.getInsight() : "No insight provided")
                .fileName(file.getOriginalFilename())
                .memberId(memberId) // ğŸ‘ˆ ì¶”ì¶œí•œ IDë¥¼ DTOì— ë‹´ìŠµë‹ˆë‹¤.
                .build();
                
            // DB ì €ì¥ ë©”ì„œë“œ í˜¸ì¶œ
            cutService.saveAnalysisResult(saveDto);
            System.out.println("âœ… ë¶„ì„ ê²°ê³¼ DB ì €ì¥ ì„±ê³µ: " + saveDto.getDetectedPart() + " by Member: " + saveDto.getMemberId());

            // 4. ìµœì¢… ë¶„ì„ ê²°ê³¼ DTOë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°˜í™˜
            // í´ë¼ì´ì–¸íŠ¸ì—ê²Œ memberIdë¥¼ í¬í•¨í•œ DTOë¥¼ ë°˜í™˜í•˜ì—¬ React ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            partResult.setMemberId(memberId);
            return ResponseEntity.ok(partResult); 
            
        } catch (Exception e) {
            System.err.println("âŒ ë¶„ì„ ë° ì €ì¥ ì¤‘ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
            e.printStackTrace(); 
            return ResponseEntity.internalServerError().body("ë¶„ì„ ë° ì €ì¥ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage());
        }
    }
    
    /**
     * 2. POST /api/cut/grade : ë“±ê¸‰ ì¸¡ì • API (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
     */
    @PostMapping("/grade")
    public ResponseEntity<?> analyzeGrade(@RequestParam("file") MultipartFile file, HttpServletRequest request) {
        
        if (file.isEmpty()) {
            return ResponseEntity.badRequest().body("ì—…ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
        }

        try {
            CutDto gradeResult = cutService.analyzeGrade(file); 
            return ResponseEntity.ok(gradeResult); 
            
        } catch (Exception e) {
            System.err.println("ë“±ê¸‰ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
            return ResponseEntity.internalServerError().body("ë“±ê¸‰ ë¶„ì„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage());
        }
    }
    
    /**
     * 3. POST /api/cut/save : ê²°ê³¼ ì €ì¥ API (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
     * *ì£¼ì˜*: í˜„ì¬ /analyzeì—ì„œ ì €ì¥ê¹Œì§€ ì²˜ë¦¬í•˜ë¯€ë¡œ ì´ APIëŠ” ì‚¬ìš©ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
     */
    @PostMapping("/save")
    public ResponseEntity<?> saveResult(@RequestBody SaveRequestDto saveRequest) {
        try {
            Cut savedCut = cutService.saveAnalysisResult(saveRequest);
            
            // ì €ì¥ëœ ê²°ê³¼ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°˜í™˜ (ì €ì¥ëœ ID í¬í•¨)
            return ResponseEntity.ok(savedCut.getId()); 
            
        } catch (Exception e) {
            System.err.println("ê²°ê³¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
            return ResponseEntity.internalServerError().body("ê²°ê³¼ ì €ì¥ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage());
        }
    }
}