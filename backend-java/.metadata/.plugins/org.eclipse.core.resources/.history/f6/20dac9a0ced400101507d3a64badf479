package com.project.beef.service;

import java.util.Map;

import org.springframework.core.io.ByteArrayResource; // ğŸ‘ˆ ìƒˆë¡œ ì¶”ê°€ëœ import
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestPart;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.multipart.MultipartFile;

import com.project.beef.domain.Cut;
import com.project.beef.dto.CutDto;
import com.project.beef.dto.SaveRequestDto;
import com.project.beef.repository.CutRepository;

import lombok.RequiredArgsConstructor;

@Service
@Transactional 
@RequiredArgsConstructor
public class CutService {
    
    private final CutRepository cutRepository; // DB ì €ì¥ì´ í•„ìš”í•  ë•Œ ì‚¬ìš©
    private final RestTemplate restTemplate; 
    private final CutService cutService;
    
    // AI ì„œë²„ ê¸°ë³¸ ì£¼ì†Œ
    private static final String AI_SERVER_URL = "http://localhost:5000";

 // í†µí•© ë¶„ì„ ë° ì €ì¥ API
    @PostMapping("/analyze") 
    public ResponseEntity<CutDto> analyze(@RequestPart("file") MultipartFile file) {
        try {
            // 1. ë¶€ìœ„ ë¶„ì„ (AI ì„œë²„ í†µì‹ )
            CutDto partResult = cutService.analyzePart(file);

            // 2. ë“±ê¸‰ ë¶„ì„ (í˜„ì¬ í•™ìŠµ ëŒ€ê¸° ì¤‘ì´ë¯€ë¡œ ìƒëµí•˜ê±°ë‚˜, ì„ì‹œë¡œ í˜¸ì¶œ)
            // CutDto gradeResult = cutService.analyzeGrade(file);
            
            // 3. (ì„ì‹œ) SaveRequestDto ìƒì„± ë° DB ì €ì¥
            // ì—¬ê¸°ì„œëŠ” ë¶€ìœ„ ê²°ê³¼ë§Œ ê°€ì§€ê³  DBì— ì €ì¥í•˜ê³  ë°”ë¡œ DTOë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
            SaveRequestDto saveDto = SaveRequestDto.builder()
                .detectedPart(partResult.getDetectedPart())
                .detectedGrade("ë¯¸ì¸¡ì •") // ì„ì‹œ ê°’
                .marblingRatio(0) // ì„ì‹œ ê°’
                .insight(partResult.getInsight())
                .fileName(file.getOriginalFilename())
                // .memberId("ì‚¬ìš©ìID") // ì‚¬ìš©ì IDê°€ ìˆë‹¤ë©´ ì¶”ê°€
                .build();
                
            // DB ì €ì¥ ë©”ì„œë“œ í˜¸ì¶œ
            cutService.saveAnalysisResult(saveDto);

            // 4. ìµœì¢… ê²°ê³¼ DTO ë°˜í™˜
            return ResponseEntity.ok(partResult);

        } catch (Exception e) {
            // ìƒì„¸ ì˜¤ë¥˜ ë¡œê·¸ ì¶œë ¥
            e.printStackTrace();
            return ResponseEntity.internalServerError().build();
        }
    }

    /**
     * 2. ë“±ê¸‰ ì¸¡ì • ì„œë¹„ìŠ¤ ë¡œì§: AI ì„œë²„ì˜ ë“±ê¸‰ ë¶„ì„ ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
     */
    public CutDto analyzeGrade(MultipartFile file) throws Exception {
        
        // AI ì„œë²„ì˜ ë“±ê¸‰ ì¸¡ì • ì—”ë“œí¬ì¸íŠ¸ URL
        String url = AI_SERVER_URL + "/analyze/grade"; 

        // AI ì„œë²„ í†µì‹  ë° ì‘ë‹µ ë°›ê¸°
        Map<String, Object> aiResponse = callAiServer(file, url);
        
        // ë§ˆë¸”ë§ ì§€ìˆ˜ Integer ë³€í™˜ ì²˜ë¦¬
        Integer marblingRatio = convertToInteger(aiResponse.get("marblingRatio"));

        // ë“±ê¸‰ ì •ë³´ë§Œ ë‹´ì€ DTOë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
        return new CutDto(
            "success", 
            null,                                        // ë¶€ìœ„ëŠ” null ì²˜ë¦¬
            (String) aiResponse.get("detectedGrade"),    // â­ ë“±ê¸‰ ê²°ê³¼
            marblingRatio,                               // ë§ˆë¸”ë§ ì§€ìˆ˜
            (String) aiResponse.get("insight")
        );
    }
    
    // -----------------------------------------------------------------
    // ê³µí†µ ë¡œì§: AI ì„œë²„ í˜¸ì¶œ í—¬í¼ ë©”ì„œë“œ (ìˆ˜ì •ëœ ë¶€ë¶„)
    // -----------------------------------------------------------------
    private Map<String, Object> callAiServer(MultipartFile file, String url) throws Exception {
        
        // 1. íŒŒì¼ì˜ ë°”ì´íŠ¸ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ì—¬ ByteArrayResourceë¡œ ê°ì‹¸ì„œ íŒŒì¼ ì´ë¦„ ë©”íƒ€ë°ì´í„°ë¥¼ í¬í•¨ì‹œí‚µë‹ˆë‹¤.
        org.springframework.core.io.Resource resource = new ByteArrayResource(file.getBytes()) {
            @Override
            public String getFilename() {
                // AI ì„œë²„ê°€ íŒŒì¼ ì´ë¦„(í™•ì¥ì)ì„ ì½ì„ ìˆ˜ ìˆë„ë¡ ì›ë³¸ íŒŒì¼ ì´ë¦„ì„ ì „ë‹¬
                return file.getOriginalFilename();
            }
        };
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.MULTIPART_FORM_DATA);
        
        MultiValueMap<String, Object> body = new LinkedMultiValueMap<>();
        // 2. ìˆ˜ì •ëœ Resource ê°ì²´ë¥¼ ë°”ë””ì— ì¶”ê°€í•©ë‹ˆë‹¤.
        body.add("file", resource); 
        
        HttpEntity<MultiValueMap<String, Object>> requestEntity = new HttpEntity<>(body, headers);

        try {
            // RestTemplateìœ¼ë¡œ AI ì„œë²„ í˜¸ì¶œ
            Map<String, Object> aiResponse = restTemplate.postForObject(url, requestEntity, Map.class);
            if (aiResponse == null) {
                 throw new IllegalStateException("AI ì„œë²„ë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
            return aiResponse;
        } catch (Exception e) {
            // Spring Boot ì½˜ì†”ì— ì •í™•í•œ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
            throw new Exception("AI ë¶„ì„ ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + e.getMessage());
        }
    }
    
    // ê³µí†µ ë¡œì§: Number ê°ì²´ë¥¼ Integerë¡œ ì•ˆì „í•˜ê²Œ ë³€í™˜
    private Integer convertToInteger(Object obj) {
        if (obj instanceof Number) {
            return ((Number) obj).intValue();
        }
        return null;
    }
    
    /**
     * 3. í†µí•© ì €ì¥ API ë¡œì§: í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ë°›ì€ ë¶„ì„ ê²°ê³¼ë¥¼ DBì— ì €ì¥í•©ë‹ˆë‹¤.
     */
    @Transactional
    public Cut saveAnalysisResult(SaveRequestDto dto) {
        
        // DTOë¥¼ ì—”í‹°í‹°ë¡œ ë³€í™˜
        Cut cut = Cut.builder()
            .detectedPart(dto.getDetectedPart())
            .detectedGrade(dto.getDetectedGrade())
            .marblingRatio(dto.getMarblingRatio())
            .insight(dto.getInsight())
            .fileName(dto.getFileName())
            // .memberId(dto.getMemberId()) // ì‚¬ìš©ì ID ì„¤ì •
            .build();
            
        // DB ì €ì¥ ë° ì €ì¥ëœ ì—”í‹°í‹° ë°˜í™˜
        return cutRepository.save(cut);
    }
}