package com.project.beef.service;

import java.util.List;
import java.util.Map;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.multipart.MultipartFile;

import com.project.beef.domain.Cut; 
import com.project.beef.dto.CutDto;
import com.project.beef.dto.SaveRequestDto; // ìµœì¢… ì €ì¥ì„ ìœ„í•œ DTO
import com.project.beef.repository.CutRepository;

import lombok.RequiredArgsConstructor;

@Service
@Transactional 
@RequiredArgsConstructor
public class CutService {
    
    private final CutRepository cutRepository; 
    private final RestTemplate restTemplate; 

    private static final String AI_SERVER_URL = "http://localhost:5000";

    // ... (getList() ë©”ì„œë“œëŠ” ìƒëµí•©ë‹ˆë‹¤)

    /**
     * 1. ë¶€ìœ„ ì¸¡ì • ì„œë¹„ìŠ¤ ë¡œì§: ğŸš¨ í˜„ì¬ Mock ë°ì´í„° ë°˜í™˜ (í•™ìŠµ ì™„ë£Œ ëŒ€ê¸° ì¤‘) ğŸš¨
     */
    public CutDto analyzePart(MultipartFile file) throws Exception {
        
        // â­ ë¶€ìœ„ ëª¨ë¸ í•™ìŠµ ì™„ë£Œ ì „ê¹Œì§€ Mock ë°ì´í„° ë°˜í™˜ â­
        System.out.println("âš ï¸ ë¶€ìœ„ ë¶„ì„: ëª¨ë¸ í•™ìŠµ ì¤‘ì´ë¯€ë¡œ Mock ë°ì´í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.");
        return new CutDto(
            "success", 
            "ë“±ì‹¬ (Mock)", 
            null,
            null,
            "ë¶€ìœ„ ëª¨ë¸ í•™ìŠµ ì™„ë£Œ ì‹œ ì‹¤ì œ AI í†µì‹ ì´ í™œì„±í™”ë©ë‹ˆë‹¤."
        );
        
        /* // â¬‡ï¸ AI ëª¨ë¸ í•™ìŠµ ì™„ë£Œ í›„ ì£¼ì„ í•´ì œí•˜ì—¬ ì‚¬ìš©í•  ì‹¤ì œ í†µì‹  ë¡œì§ â¬‡ï¸
        // String url = AI_SERVER_URL + "/analyze/part"; 
        // Map<String, Object> aiResponse = callAiServer(file, url);
        // return new CutDto("success", (String) aiResponse.get("detectedPart"), null, null, (String) aiResponse.get("insight"));
        */
    }

    /**
     * 2. ë“±ê¸‰ ì¸¡ì • ì„œë¹„ìŠ¤ ë¡œì§: ğŸŒŸ ì‹¤ì œ AI ì„œë²„ í†µì‹  ğŸŒŸ
     */
    public CutDto analyzeGrade(MultipartFile file) throws Exception {
        
        String url = AI_SERVER_URL + "/analyze/grade"; 
        Map<String, Object> aiResponse = callAiServer(file, url);
        
        Integer marblingRatio = convertToInteger(aiResponse.get("marblingRatio"));

        // ë“±ê¸‰ ì •ë³´ë§Œ ë‹´ì€ DTOë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
        return new CutDto(
            "success", 
            null,                                        
            (String) aiResponse.get("detectedGrade"),    
            marblingRatio,                               
            (String) aiResponse.get("insight")
        );
    }
    
    // -----------------------------------------------------------------
    // ê³µí†µ ë¡œì§: AI ì„œë²„ í˜¸ì¶œ í—¬í¼ ë©”ì„œë“œ
    // -----------------------------------------------------------------
    private Map<String, Object> callAiServer(MultipartFile file, String url) throws Exception {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.MULTIPART_FORM_DATA);
        
        MultiValueMap<String, Object> body = new LinkedMultiValueMap<>();
        body.add("file", file.getResource()); 
        
        HttpEntity<MultiValueMap<String, Object>> requestEntity = new HttpEntity<>(body, headers);

        try {
            Map<String, Object> aiResponse = restTemplate.postForObject(url, requestEntity, Map.class);
            if (aiResponse == null) {
                 throw new IllegalStateException("AI ì„œë²„ë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
            return aiResponse;
        } catch (Exception e) {
            // í†µì‹  ì˜¤ë¥˜ ë°œìƒ ì‹œ Connection refused ë“±ì˜ ë©”ì‹œì§€ê°€ ë‹´ê²¨ ì „ë‹¬ë©ë‹ˆë‹¤.
            throw new Exception("AI ë¶„ì„ ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + e.getMessage());
        }
    }
    
    // ê³µí†µ ë¡œì§: Number ê°ì²´ë¥¼ Integerë¡œ ì•ˆì „í•˜ê²Œ ë³€í™˜
    private Integer convertToInteger(Object obj) {
        if (obj instanceof Number) {
            return ((Number) obj).intValue();
        }
        return null;
    }
    
    // -----------------------------------------------------------------
    // 3. í†µí•© ì €ì¥ API ë¡œì§ (DB ì €ì¥)
    // -----------------------------------------------------------------
    @Transactional
    public Cut saveAnalysisResult(SaveRequestDto dto) {
        
        // DTOë¥¼ Cut ì—”í‹°í‹°ë¡œ ë³€í™˜
        Cut cut = Cut.builder()
            .detectedPart(dto.getDetectedPart())
            .detectedGrade(dto.getDetectedGrade())
            .marblingRatio(dto.getMarblingRatio())
            .insight(dto.getInsight())
            .fileName(dto.getFileName())
            // ... (í•„ìš”í•œ ê²½ìš°, ì‚¬ìš©ì ID, ì‹œê°í™” URL ë“± ì¶”ê°€ í•„ë“œ ì„¤ì •)
            .build();
            
        // DB ì €ì¥ ì‹¤í–‰
        return cutRepository.save(cut);
    }
}