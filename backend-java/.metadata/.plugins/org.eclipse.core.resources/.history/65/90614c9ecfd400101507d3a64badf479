package com.project.beef.service;

import java.util.Map;

import org.springframework.core.io.ByteArrayResource; // ğŸ‘ˆ ìƒˆë¡œ ì¶”ê°€ëœ import
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.multipart.MultipartFile;

import com.project.beef.domain.Cut;
import com.project.beef.dto.CutDto;
import com.project.beef.dto.SaveRequestDto;
import com.project.beef.repository.CutRepository;

import lombok.RequiredArgsConstructor;

@Service
@Transactional 
@RequiredArgsConstructor
public class CutService {
    
    private final CutRepository cutRepository; // DB ì €ì¥ì´ í•„ìš”í•  ë•Œ ì‚¬ìš©
    private final RestTemplate restTemplate; 

    // AI ì„œë²„ ê¸°ë³¸ ì£¼ì†Œ
    private static final String AI_SERVER_URL = "http://localhost:5000";

    // ... (getList() ë©”ì„œë“œ ìƒëµ)

    /**
     * 1. ë¶€ìœ„ ì¸¡ì • ì„œë¹„ìŠ¤ ë¡œì§: AI ì„œë²„ì˜ ë¶€ìœ„ ë¶„ì„ ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
     */
    public CutDto analyzePart(MultipartFile file) throws Exception {
        
        // AI ì„œë²„ì˜ ë¶€ìœ„ ì¸¡ì • ì—”ë“œí¬ì¸íŠ¸ URL
        String url = AI_SERVER_URL + "/analyze/part"; 
        
        // AI ì„œë²„ í†µì‹  ë° ì‘ë‹µ ë°›ê¸°
        Map<String, Object> aiResponse = callAiServer(file, url);

        // ë¶€ìœ„ ì •ë³´ë§Œ ë‹´ì€ DTOë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
        return new CutDto(
            "success", 
            (String) aiResponse.get("detectedPart"), // â­ ë¶€ìœ„ ê²°ê³¼
            null,                                    // ë“±ê¸‰ì€ null ì²˜ë¦¬
            null,
            (String) aiResponse.get("insight")
        );
    }

    /**
     * 2. ë“±ê¸‰ ì¸¡ì • ì„œë¹„ìŠ¤ ë¡œì§: AI ì„œë²„ì˜ ë“±ê¸‰ ë¶„ì„ ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
     */
    public CutDto analyzeGrade(MultipartFile file) throws Exception {
        
        // AI ì„œë²„ì˜ ë“±ê¸‰ ì¸¡ì • ì—”ë“œí¬ì¸íŠ¸ URL
        String url = AI_SERVER_URL + "/analyze/grade"; 

        // AI ì„œë²„ í†µì‹  ë° ì‘ë‹µ ë°›ê¸°
        Map<String, Object> aiResponse = callAiServer(file, url);
        
        // ë§ˆë¸”ë§ ì§€ìˆ˜ Integer ë³€í™˜ ì²˜ë¦¬
        Integer marblingRatio = convertToInteger(aiResponse.get("marblingRatio"));

        // ë“±ê¸‰ ì •ë³´ë§Œ ë‹´ì€ DTOë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
        return new CutDto(
            "success", 
            null,                                        // ë¶€ìœ„ëŠ” null ì²˜ë¦¬
            (String) aiResponse.get("detectedGrade"),    // â­ ë“±ê¸‰ ê²°ê³¼
            marblingRatio,                               // ë§ˆë¸”ë§ ì§€ìˆ˜
            (String) aiResponse.get("insight")
        );
    }
    
    private Map<String, Object> callAiServer(MultipartFile file, String url) throws Exception {
        
        org.springframework.core.io.Resource resource = new ByteArrayResource(file.getBytes()) {
            @Override
            public String getFilename() {
                return file.getOriginalFilename();
            }
        };
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.MULTIPART_FORM_DATA);
        
        MultiValueMap<String, Object> body = new LinkedMultiValueMap<>();
        body.add("file", resource); 
        
        HttpEntity<MultiValueMap<String, Object>> requestEntity = new HttpEntity<>(body, headers);

        try {
            Map<String, Object> aiResponse = restTemplate.postForObject(url, requestEntity, Map.class);
            if (aiResponse == null) {
                 throw new IllegalStateException("AI ì„œë²„ë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
            return aiResponse;
        } catch (Exception e) {
            throw new Exception("AI ë¶„ì„ ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + e.getMessage());
        }
    }
    
    private Integer convertToInteger(Object obj) {
        if (obj instanceof Number) {
            return ((Number) obj).intValue();
        }
        return null;
    }
    
    @Transactional
    public Cut saveAnalysisResult(SaveRequestDto dto) {
        
        Cut cut = Cut.builder()
            .detectedPart(dto.getDetectedPart())
            .detectedGrade(dto.getDetectedGrade())
            .marblingRatio(dto.getMarblingRatio())
            .insight(dto.getInsight())
            .fileName(dto.getFileName())
            .memberId(dto.getMemberId()) // ì‚¬ìš©ì ID ì„¤ì •
            .build();
            
        // DB ì €ì¥ ë° ì €ì¥ëœ ì—”í‹°í‹° ë°˜í™˜
        return cutRepository.save(cut);
    }
}