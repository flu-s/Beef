package com.project.beef.service;

import java.util.Map;

import org.springframework.core.io.ByteArrayResource; 
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.multipart.MultipartFile;

import com.project.beef.domain.Cut;
import com.project.beef.dto.CutDto;
import com.project.beef.dto.SaveRequestDto;
import com.project.beef.repository.CutRepository;

import lombok.RequiredArgsConstructor;

@Service
@Transactional 
@RequiredArgsConstructor
public class CutService {
    
    private final CutRepository cutRepository; 
    private final RestTemplate restTemplate; 

    private static final String AI_SERVER_URL = "http://localhost:5000";


    // ----------------------------------------------------
    // ⭐ 3. 부위 및 등급 분석을 순차적으로 실행하고 결과를 결합하는 핵심 메서드 ⭐
    // ----------------------------------------------------
    public CutDto analyzeAndCombine(MultipartFile file) throws Exception {
        
        // 1. 부위 분석 실행
        CutDto partResult = analyzePart(file);
        
        // 2. 등급 분석 실행
        CutDto gradeResult = analyzeGrade(file);
        
        String combinedInsight = partResult.getInsight() + "(등급 분석: " + gradeResult.getInsight() + ")";
        
        return CutDto.builder()
            .status("success")
            .detectedPart(partResult.getDetectedPart())
            .detectedGrade(gradeResult.getDetectedGrade())
            .marblingRatio(gradeResult.getMarblingRatio())
            .insight(combinedInsight) // ⭐ 결합된 Insight 사용 ⭐
            .memberId(null) // 실제 사용 시 MemberId를 Controller에서 받아와야 합니다.
            .build();
    }
    
    public CutDto analyzePart(MultipartFile file) throws Exception {
        
        String url = AI_SERVER_URL + "/analyze/part"; 
        Map<String, Object> aiResponse = callAiServer(file, url);

        return CutDto.builder()
            .status("success")
            .detectedPart((String) aiResponse.get("detectedPart"))
            .insight((String) aiResponse.get("insight"))
            .detectedGrade(null)
            .marblingRatio(null)
            .memberId(null)
            .build();
    }

    public CutDto analyzeGrade(MultipartFile file) throws Exception {
        
        String url = AI_SERVER_URL + "/analyze/grade"; 
        Map<String, Object> aiResponse = callAiServer(file, url);
        
        Integer marblingRatio = convertToInteger(aiResponse.get("marblingRatio"));

        return CutDto.builder()
            .status("success")
            .detectedGrade((String) aiResponse.get("detectedGrade"))
            .marblingRatio(marblingRatio)
            .insight((String) aiResponse.get("insight"))
            .detectedPart(null)
            .memberId(null)
            .build();
    }
    
    private Map<String, Object> callAiServer(MultipartFile file, String url) throws Exception {
        // (기존 코드와 동일)
        org.springframework.core.io.Resource resource = new ByteArrayResource(file.getBytes()) {
            @Override
            public String getFilename() {
                return file.getOriginalFilename();
            }
        };
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.MULTIPART_FORM_DATA);
        
        MultiValueMap<String, Object> body = new LinkedMultiValueMap<>();
        body.add("file", resource); 
        
        HttpEntity<MultiValueMap<String, Object>> requestEntity = new HttpEntity<>(body, headers);

        try {
            Map<String, Object> aiResponse = restTemplate.postForObject(url, requestEntity, Map.class);
            if (aiResponse == null) {
                 throw new IllegalStateException("AI 서버로부터 유효한 응답을 받지 못했습니다.");
            }
            return aiResponse;
        } catch (Exception e) {
            throw new Exception("AI 분석 서버 통신 오류: " + e.getMessage());
        }
    }
    
    private Integer convertToInteger(Object obj) {
        if (obj instanceof Number) {
            return ((Number) obj).intValue();
        }
        return null;
    }
    
    @Transactional
    public Cut saveAnalysisResult(SaveRequestDto dto) {
        
        Cut cut = Cut.builder()
            .detectedPart(dto.getDetectedPart())
            .detectedGrade(dto.getDetectedGrade())
            .marblingRatio(dto.getMarblingRatio())
            .insight(dto.getInsight())
            .fileName(dto.getFileName())
            .memberId(dto.getMemberId())
            .build();
            
        return cutRepository.save(cut);
    }
}